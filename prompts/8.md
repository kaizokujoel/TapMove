# Prompt 8: Backend Authentication & Security

## Objective
Add proper authentication middleware and security measures to the backend API.

## Pre-requisites
1. **Read issues first**: Check `docs/issues/movement/README.md` and `docs/issues/tooling/README.md`
2. **Load skill**: `skill: "code-structure"`

## Context
The backend currently has minimal security. For a hackathon demo this is acceptable, but we need basic protection.

## Tasks

### 1. Add API key authentication for merchant routes
Create `backend/src/middleware/auth.js`:

```javascript
// Simple API key auth for merchant routes
export const merchantAuth = (req, res, next) => {
  const apiKey = req.headers['x-api-key'];

  if (!apiKey) {
    return res.status(401).json({ error: 'API key required' });
  }

  // For MVP: validate against stored merchant API keys
  const merchant = getMerchantByApiKey(apiKey);
  if (!merchant) {
    return res.status(403).json({ error: 'Invalid API key' });
  }

  req.merchant = merchant;
  next();
};

// Public routes (payment lookup, etc) - no auth needed
export const publicRoute = (req, res, next) => next();
```

### 2. Add rate limiting
```bash
npm install express-rate-limit
```

Create `backend/src/middleware/rate-limit.js`:
```javascript
import rateLimit from 'express-rate-limit';

export const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // 100 requests per window
  message: { error: 'Too many requests, please try again later' }
});

export const paymentLimiter = rateLimit({
  windowMs: 60 * 1000, // 1 minute
  max: 10, // 10 payment creations per minute
  message: { error: 'Too many payment requests' }
});
```

### 3. Add request validation
```bash
npm install express-validator
```

Create `backend/src/middleware/validate.js`:
```javascript
import { body, param, validationResult } from 'express-validator';

export const validatePaymentCreate = [
  body('merchantAddress')
    .isString()
    .matches(/^0x[a-fA-F0-9]{64}$/)
    .withMessage('Invalid merchant address'),
  body('amount')
    .isString()
    .matches(/^\d+(\.\d{1,6})?$/)
    .withMessage('Invalid amount format'),
  body('memo')
    .optional()
    .isString()
    .isLength({ max: 256 })
    .withMessage('Memo too long'),
];

export const validateMerchantRegister = [
  body('name')
    .isString()
    .isLength({ min: 1, max: 100 })
    .withMessage('Name required (max 100 chars)'),
  body('category')
    .optional()
    .isString()
    .isLength({ max: 50 }),
  body('webhookUrl')
    .optional()
    .isURL()
    .withMessage('Invalid webhook URL'),
];

export const validate = (req, res, next) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }
  next();
};
```

### 4. Add CORS configuration
Update `backend/src/index.js`:
```javascript
import cors from 'cors';

const corsOptions = {
  origin: [
    'http://localhost:3000',      // Merchant dev
    'http://localhost:8081',      // Mobile dev
    'https://tapmove.app',        // Production
  ],
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'x-api-key', 'Authorization'],
};

app.use(cors(corsOptions));
```

### 5. Add request logging
Create `backend/src/middleware/logger.js`:
```javascript
export const requestLogger = (req, res, next) => {
  const start = Date.now();

  res.on('finish', () => {
    const duration = Date.now() - start;
    console.log(
      `${req.method} ${req.path} ${res.statusCode} ${duration}ms`
    );
  });

  next();
};
```

### 6. Generate API keys for merchants
Add to `backend/src/services/merchant.js`:
```javascript
import crypto from 'crypto';

export const generateApiKey = () => {
  return `tm_${crypto.randomBytes(24).toString('hex')}`;
};

// On merchant registration, generate and store API key
export const registerMerchant = async (data) => {
  const apiKey = generateApiKey();
  // Store hashed version
  const apiKeyHash = crypto
    .createHash('sha256')
    .update(apiKey)
    .digest('hex');

  // Return plain key once (merchant must save it)
  return { ...merchant, apiKey };
};
```

### 7. Apply middleware to routes
Update `backend/src/routes/merchant.js`:
```javascript
import { merchantAuth } from '../middleware/auth.js';
import { validateMerchantRegister, validate } from '../middleware/validate.js';
import { paymentLimiter } from '../middleware/rate-limit.js';

// Protected merchant routes
router.post('/:address/payment',
  merchantAuth,
  paymentLimiter,
  validatePaymentCreate,
  validate,
  createPayment
);

// Public routes
router.get('/:address', getMerchant);
```

### 8. Add security headers
```bash
npm install helmet
```

```javascript
import helmet from 'helmet';
app.use(helmet());
```

## Verification
```bash
# Test without API key (should fail)
curl -X POST http://localhost:3001/api/merchant/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Shop"}'

# Test with invalid data (should fail validation)
curl -X POST http://localhost:3001/api/payments \
  -H "Content-Type: application/json" \
  -d '{"merchantAddress":"invalid","amount":"abc"}'

# Test rate limiting
for i in {1..15}; do curl http://localhost:3001/api/payments; done
```

## Files to Create/Modify
- `backend/src/middleware/auth.js` (NEW)
- `backend/src/middleware/rate-limit.js` (NEW)
- `backend/src/middleware/validate.js` (NEW)
- `backend/src/middleware/logger.js` (NEW)
- `backend/src/index.js` (apply middleware)
- `backend/src/routes/merchant.js` (apply auth)
- `backend/src/routes/payment.js` (apply validation)
- `backend/src/services/merchant.js` (API key generation)

## DO NOT
- Store API keys in plain text (hash them)
- Log sensitive data (keys, passwords)
- Make rate limits too strict for demo
- Require auth for public payment lookup routes
