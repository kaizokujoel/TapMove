# Prompt 10: Environment Configuration & Deployment Prep

## Objective
Create proper environment configuration for development, staging, and production deployments.

## Pre-requisites
1. **Read issues first**: Check `docs/issues/tooling/README.md`
2. **All previous prompts should be completed**

## Context
The app needs proper environment separation and deployment configuration for:
- Local development
- Movement testnet demo
- Future production deployment

## Tasks

### 1. Create root-level environment template
Create `.env.example` in project root:

```bash
# ================================
# TapMove Environment Configuration
# ================================

# Environment: development | staging | production
NODE_ENV=development

# ================================
# Movement Network
# ================================
MOVEMENT_RPC_URL=https://aptos.testnet.porto.movementlabs.xyz/v1
MOVEMENT_FAUCET_URL=https://faucet.testnet.porto.movementlabs.xyz
MOVEMENT_EXPLORER_URL=https://explorer.movementlabs.xyz

# Deployed Contract Addresses
PAYMENT_MODULE_ADDRESS=0x_YOUR_DEPLOYED_ADDRESS_HERE
MERCHANT_MODULE_ADDRESS=0x_YOUR_DEPLOYED_ADDRESS_HERE
USDC_COIN_ADDRESS=0x_USDC_ADDRESS_HERE

# ================================
# Privy Authentication
# ================================
PRIVY_APP_ID=your-privy-app-id
PRIVY_APP_SECRET=your-privy-app-secret

# ================================
# Backend Configuration
# ================================
BACKEND_PORT=3001
BACKEND_URL=http://localhost:3001
DATABASE_PATH=./data/tapmove.db

# ================================
# Frontend URLs
# ================================
MERCHANT_TERMINAL_URL=http://localhost:3000
MOBILE_DEEP_LINK_SCHEME=tapmove
```

### 2. Create backend environment config
Create `backend/.env.example`:

```bash
# Server
PORT=3001
NODE_ENV=development

# Movement Network
MOVEMENT_RPC_URL=https://aptos.testnet.porto.movementlabs.xyz/v1
MOVEMENT_FAUCET_URL=https://faucet.testnet.porto.movementlabs.xyz

# Contract Addresses
PAYMENT_MODULE=0x_ADDRESS::payment
MERCHANT_MODULE=0x_ADDRESS::merchant

# Database
DATABASE_PATH=./data/tapmove.db

# Webhook Secret (for verifying callbacks)
WEBHOOK_SECRET=your-webhook-secret

# Cors Origins (comma-separated)
CORS_ORIGINS=http://localhost:3000,http://localhost:8081
```

### 3. Create merchant terminal environment config
Create `merchant/.env.example`:

```bash
# Privy
NEXT_PUBLIC_PRIVY_APP_ID=your-privy-app-id

# Backend API
NEXT_PUBLIC_API_URL=http://localhost:3001/api

# Movement Network
NEXT_PUBLIC_MOVEMENT_RPC=https://aptos.testnet.porto.movementlabs.xyz/v1
NEXT_PUBLIC_MOVEMENT_EXPLORER=https://explorer.movementlabs.xyz

# Contract Addresses
NEXT_PUBLIC_PAYMENT_MODULE=0x_ADDRESS::payment
NEXT_PUBLIC_MERCHANT_MODULE=0x_ADDRESS::merchant
```

### 4. Create mobile app environment config
Create `mobile/.env.example`:

```bash
# Privy
EXPO_PUBLIC_PRIVY_APP_ID=your-privy-app-id

# Backend API
EXPO_PUBLIC_API_URL=http://localhost:3001/api

# Movement Network
EXPO_PUBLIC_MOVEMENT_RPC=https://aptos.testnet.porto.movementlabs.xyz/v1

# Deep Link
EXPO_PUBLIC_DEEP_LINK_SCHEME=tapmove
```

### 5. Create environment loader utility
Create `backend/src/lib/env.js`:

```javascript
import dotenv from 'dotenv';
import path from 'path';

// Load environment variables
dotenv.config();

// Validate required variables
const required = [
  'MOVEMENT_RPC_URL',
  'PAYMENT_MODULE',
];

const missing = required.filter(key => !process.env[key]);
if (missing.length > 0) {
  console.error(`Missing required env vars: ${missing.join(', ')}`);
  console.error('Copy .env.example to .env and fill in values');
  process.exit(1);
}

export const config = {
  port: parseInt(process.env.PORT || '3001'),
  nodeEnv: process.env.NODE_ENV || 'development',

  movement: {
    rpcUrl: process.env.MOVEMENT_RPC_URL,
    faucetUrl: process.env.MOVEMENT_FAUCET_URL,
    paymentModule: process.env.PAYMENT_MODULE,
    merchantModule: process.env.MERCHANT_MODULE,
  },

  database: {
    path: process.env.DATABASE_PATH || './data/tapmove.db',
  },

  cors: {
    origins: (process.env.CORS_ORIGINS || '').split(',').filter(Boolean),
  },

  isDev: process.env.NODE_ENV === 'development',
  isProd: process.env.NODE_ENV === 'production',
};
```

### 6. Update apps to use config
Update `backend/src/index.js`:
```javascript
import { config } from './lib/env.js';

app.listen(config.port, () => {
  console.log(`Server running on port ${config.port}`);
  console.log(`Environment: ${config.nodeEnv}`);
  console.log(`Movement RPC: ${config.movement.rpcUrl}`);
});
```

### 7. Create deployment documentation
Create `docs/deployment/README.md`:

```markdown
# TapMove Deployment Guide

## Prerequisites
- Node.js 18+
- Movement CLI (aptos)
- Privy account with app configured

## Quick Start (Local Development)

1. Copy environment files:
   ```bash
   cp .env.example .env
   cp backend/.env.example backend/.env
   cp merchant/.env.example merchant/.env
   cp mobile/.env.example mobile/.env
   ```

2. Fill in Privy credentials and contract addresses

3. Start services:
   ```bash
   # Terminal 1: Backend
   cd backend && npm run dev

   # Terminal 2: Merchant Terminal
   cd merchant && npm run dev

   # Terminal 3: Mobile App
   cd mobile && npx expo start
   ```

## Deploying Contracts
See `contracts/README.md` for deployment instructions.

## Production Deployment
TBD - Vercel for merchant terminal, Railway for backend.
```

### 8. Create startup script
Create `scripts/start-dev.sh`:

```bash
#!/bin/bash

echo "ðŸš€ Starting TapMove Development Environment"

# Check for .env files
if [ ! -f "backend/.env" ]; then
  echo "âŒ backend/.env not found. Run: cp backend/.env.example backend/.env"
  exit 1
fi

# Start backend
echo "ðŸ“¦ Starting backend..."
cd backend && npm run dev &
BACKEND_PID=$!

# Start merchant terminal
echo "ðŸª Starting merchant terminal..."
cd ../merchant && npm run dev &
MERCHANT_PID=$!

echo "âœ… Services started!"
echo "   Backend: http://localhost:3001"
echo "   Merchant: http://localhost:3000"
echo ""
echo "ðŸ“± Start mobile app manually: cd mobile && npx expo start"
echo ""
echo "Press Ctrl+C to stop all services"

trap "kill $BACKEND_PID $MERCHANT_PID 2>/dev/null" EXIT
wait
```

### 9. Add .gitignore entries
Update root `.gitignore`:

```
# Environment files
.env
.env.local
.env.*.local

# Database
*.db
data/

# Logs
logs/
*.log

# Build outputs
dist/
.next/
.expo/
```

## Verification
```bash
# Check all .env.example files exist
ls -la */.env.example

# Start with startup script
chmod +x scripts/start-dev.sh
./scripts/start-dev.sh

# Verify env validation works (should error with missing vars)
rm backend/.env
cd backend && npm run dev  # Should show missing vars error
```

## Files to Create
- `.env.example` (root)
- `backend/.env.example`
- `merchant/.env.example`
- `mobile/.env.example`
- `backend/src/lib/env.js`
- `docs/deployment/README.md`
- `scripts/start-dev.sh`
- `.gitignore` (update)

## DO NOT
- Commit actual .env files
- Hardcode secrets anywhere
- Skip env validation
- Use different var names across apps (keep consistent)
