# Prompt 1: Backend Database Persistence Layer

## Objective
Replace the in-memory database with persistent storage using SQLite (for simplicity) or PostgreSQL (for production).

## Pre-requisites
1. **Read issues first**: Check `docs/issues/movement/README.md` and `docs/issues/tooling/README.md` for any database-related learnings
2. **Load skill**: `skill: "code-structure"` - Follow file size limits

## Context
Currently `/backend/src/lib/db.js` uses in-memory Maps that lose all data on restart. This breaks:
- Payment tracking across restarts
- Merchant registration persistence
- Transaction history

## Tasks

### 1. Install SQLite dependencies
```bash
cd backend && npm install better-sqlite3
```

### 2. Create database schema file
Create `backend/src/lib/schema.sql`:
```sql
-- Payments table
CREATE TABLE IF NOT EXISTS payments (
  id TEXT PRIMARY KEY,
  merchant_address TEXT NOT NULL,
  amount TEXT NOT NULL,
  currency TEXT DEFAULT 'USDC',
  memo TEXT,
  status TEXT DEFAULT 'pending',
  payer_address TEXT,
  tx_hash TEXT,
  created_at INTEGER NOT NULL,
  expires_at INTEGER NOT NULL,
  completed_at INTEGER,
  refunded_at INTEGER
);

-- Merchants table
CREATE TABLE IF NOT EXISTS merchants (
  address TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  category TEXT,
  logo_url TEXT,
  webhook_url TEXT,
  total_volume TEXT DEFAULT '0',
  total_transactions INTEGER DEFAULT 0,
  verified INTEGER DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_payments_merchant ON payments(merchant_address);
CREATE INDEX IF NOT EXISTS idx_payments_status ON payments(status);
CREATE INDEX IF NOT EXISTS idx_payments_expires ON payments(expires_at);
```

### 3. Refactor db.js to use SQLite
Replace `backend/src/lib/db.js` with SQLite implementation:
- Initialize database on startup
- Run schema migrations
- Implement all existing methods using SQL queries
- Add proper error handling

### 4. Update payment service
Update `backend/src/services/payment.js`:
- Use new db methods
- Handle database errors gracefully
- Add transaction support for atomic operations

### 5. Add database file to .gitignore
```
backend/data/tapmove.db
```

## Verification
```bash
# Start backend
cd backend && npm run dev

# Create a payment
curl -X POST http://localhost:3001/api/payments \
  -H "Content-Type: application/json" \
  -d '{"merchantAddress":"0x123","amount":"10.00","memo":"Test"}'

# Restart server and verify payment still exists
# Kill server, restart, then:
curl http://localhost:3001/api/payments/{id}
```

## Files to Create/Modify
- `backend/src/lib/schema.sql` (NEW)
- `backend/src/lib/db.js` (MODIFY)
- `backend/src/services/payment.js` (MODIFY)
- `backend/.gitignore` (MODIFY)

## DO NOT
- Use an ORM (keep it simple with raw SQL)
- Create migrations system (just run schema on startup)
- Change API response formats
