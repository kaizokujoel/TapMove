# Prompt 4: Mobile Payment Flow Integration & Error Handling

## Objective
Ensure the mobile app payment flow works end-to-end with proper error handling, loading states, and edge case coverage.

## Pre-requisites
1. **Read issues first**: Check `docs/issues/ui/README.md` and `docs/issues/movement/README.md`
2. **Prompt 3 must be completed** - Need deployed contract addresses
3. **Load skill**: `skill: "ui-dev"` then `skill: "nfc-payments"`

## Context
The mobile payment flow exists but needs:
- Robust error handling for network failures
- Timeout handling for slow transactions
- Better loading/progress states
- Edge case handling (insufficient balance, expired payment, etc.)

## Tasks

### 1. Review and update payment hook
Check `mobile/hooks/use-payment.ts`:

Add comprehensive error handling:
```typescript
type PaymentError =
  | { type: 'INSUFFICIENT_BALANCE'; required: string; available: string }
  | { type: 'PAYMENT_EXPIRED'; expiredAt: number }
  | { type: 'NETWORK_ERROR'; message: string }
  | { type: 'SIGNING_REJECTED'; message: string }
  | { type: 'TRANSACTION_FAILED'; txHash?: string; message: string }
  | { type: 'TIMEOUT'; message: string };
```

### 2. Add transaction timeout handling
In payment submission, add timeout:
```typescript
const PAYMENT_TIMEOUT_MS = 30000; // 30 seconds

const submitWithTimeout = async (tx) => {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), PAYMENT_TIMEOUT_MS);

  try {
    const result = await submitTransaction(tx, { signal: controller.signal });
    return result;
  } finally {
    clearTimeout(timeoutId);
  }
};
```

### 3. Add balance pre-check
Before showing payment confirmation, verify balance:
```typescript
const { balance } = useBalance();

// In pay/[id].tsx, before confirming
if (parseFloat(balance) < parseFloat(paymentRequest.amount)) {
  setError({
    type: 'INSUFFICIENT_BALANCE',
    required: paymentRequest.amount,
    available: balance
  });
  return;
}
```

### 4. Update payment confirmation UI
In `mobile/app/pay/[id].tsx`:
- Show clear loading states during signing
- Show transaction progress (signing → submitting → confirming)
- Add retry button on recoverable errors
- Add "Go Home" on fatal errors

### 5. Add payment expiry check
Before processing, verify payment hasn't expired:
```typescript
if (paymentRequest.expiry < Date.now() / 1000) {
  setError({
    type: 'PAYMENT_EXPIRED',
    expiredAt: paymentRequest.expiry
  });
  return;
}
```

### 6. Improve error display component
Update `mobile/components/pay/payment-error.tsx`:
- Show specific error messages for each error type
- Provide actionable suggestions (add funds, retry, contact merchant)
- Add support contact info

### 7. Add retry logic for network errors
```typescript
const MAX_RETRIES = 2;
const RETRY_DELAY_MS = 2000;

const submitWithRetry = async (tx, retries = 0) => {
  try {
    return await submitTransaction(tx);
  } catch (error) {
    if (isNetworkError(error) && retries < MAX_RETRIES) {
      await delay(RETRY_DELAY_MS);
      return submitWithRetry(tx, retries + 1);
    }
    throw error;
  }
};
```

### 8. Add transaction status polling
After submission, poll for confirmation:
```typescript
const pollTransactionStatus = async (txHash: string) => {
  const MAX_POLLS = 10;
  const POLL_INTERVAL = 1000;

  for (let i = 0; i < MAX_POLLS; i++) {
    const status = await getTransactionStatus(txHash);
    if (status === 'success') return true;
    if (status === 'failed') throw new Error('Transaction failed');
    await delay(POLL_INTERVAL);
  }
  throw new Error('Transaction confirmation timeout');
};
```

### 9. Add haptic feedback
Use expo-haptics for payment events:
```typescript
import * as Haptics from 'expo-haptics';

// On payment success
Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);

// On payment error
Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
```

## Verification
Test these scenarios:
1. ✅ Successful payment flow
2. ✅ Insufficient balance error
3. ✅ Expired payment error
4. ✅ Network timeout (disable network during payment)
5. ✅ User cancels signing
6. ✅ Transaction fails on-chain

## Files to Modify
- `mobile/hooks/use-payment.ts` (error handling, retries)
- `mobile/app/pay/[id].tsx` (loading states, error display)
- `mobile/components/pay/payment-error.tsx` (error UI)
- `mobile/components/pay/confirm-button.tsx` (loading states)

## DO NOT
- Add infinite retries
- Hide errors from users
- Auto-retry signing (user must initiate)
- Skip haptic feedback
