# Prompt 7: Mobile NFC Reading & Deep Link Handling

## Objective
Ensure the mobile app correctly reads NFC tags and handles deep links from both NFC and QR scans.

## Pre-requisites
1. **Read issues first**: Check `docs/issues/ui/README.md` and `docs/issues/movement/README.md`
2. **Load skill**: `skill: "nfc-payments"` then `skill: "ui-dev"`
3. **Physical Android device required** - NFC doesn't work in simulator

## Context
The mobile app has NFC reading implemented but needs:
- Robust deep link handling
- Background NFC reading
- Proper app state management on NFC tap

## Tasks

### 1. Review NFC manager implementation
Check `mobile/lib/nfc/nfc-manager.ts`:

Ensure it handles:
```typescript
// Tag formats to support
const SUPPORTED_FORMATS = [
  'tapmove://pay?id=xxx',        // Our custom scheme
  'https://tapmove.app/pay/xxx', // Universal link fallback
];
```

### 2. Configure deep linking in Expo
Update `mobile/app.json`:
```json
{
  "expo": {
    "scheme": "tapmove",
    "android": {
      "intentFilters": [
        {
          "action": "VIEW",
          "autoVerify": true,
          "data": [
            {
              "scheme": "tapmove",
              "host": "*",
              "pathPrefix": "/pay"
            }
          ],
          "category": ["BROWSABLE", "DEFAULT"]
        }
      ]
    }
  }
}
```

### 3. Update root layout for deep links
In `mobile/app/_layout.tsx`:
```typescript
import * as Linking from 'expo-linking';
import { useEffect } from 'react';
import { useRouter } from 'expo-router';

export default function RootLayout() {
  const router = useRouter();

  useEffect(() => {
    // Handle deep link when app is already open
    const subscription = Linking.addEventListener('url', ({ url }) => {
      handleDeepLink(url);
    });

    // Handle deep link that opened the app
    Linking.getInitialURL().then((url) => {
      if (url) handleDeepLink(url);
    });

    return () => subscription.remove();
  }, []);

  const handleDeepLink = (url: string) => {
    const parsed = Linking.parse(url);
    if (parsed.path === 'pay' && parsed.queryParams?.id) {
      router.push(`/pay/${parsed.queryParams.id}`);
    }
  };

  // ... rest of layout
}
```

### 4. Handle NFC tap while app is backgrounded
Update NFC provider to handle background reading:
```typescript
// In mobile/providers/nfc-provider.tsx
useEffect(() => {
  const handleBackgroundTag = async () => {
    // Check if app was opened by NFC
    const tag = await NfcManager.getBackgroundTag();
    if (tag) {
      const uri = parseNdefUri(tag);
      if (uri) handlePaymentUri(uri);
      NfcManager.clearBackgroundTag();
    }
  };

  handleBackgroundTag();
}, []);
```

### 5. Add NFC permission handling
Create proper permission flow:
```typescript
const requestNfcPermission = async (): Promise<boolean> => {
  const isSupported = await NfcManager.isSupported();
  if (!isSupported) {
    Alert.alert('NFC Not Supported', 'Your device does not support NFC.');
    return false;
  }

  const isEnabled = await NfcManager.isEnabled();
  if (!isEnabled) {
    Alert.alert(
      'NFC Disabled',
      'Please enable NFC in your device settings.',
      [
        { text: 'Open Settings', onPress: () => NfcManager.goToNfcSetting() },
        { text: 'Cancel', style: 'cancel' }
      ]
    );
    return false;
  }

  return true;
};
```

### 6. Add visual NFC reading indicator
Update `mobile/components/nfc/nfc-status.tsx`:
- Show pulsing animation when listening
- Show success checkmark when tag read
- Show error state if read fails

### 7. Handle edge cases
- App opened from NFC while logged out → Queue payment, show after login
- NFC read while on payment screen → Ask to replace current payment
- Invalid/expired payment ID from NFC → Show error with retry

### 8. Add NFC toggle in settings
Allow users to disable NFC reading:
```typescript
// In settings screen
<Switch
  value={nfcEnabled}
  onValueChange={setNfcEnabled}
  label="NFC Payments"
  description="Tap to pay at NFC terminals"
/>
```

## Verification
1. **Deep link from browser:**
   - Open `tapmove://pay?id=test123` in browser
   - App should open to payment screen

2. **NFC read while app open:**
   - Open app on home screen
   - Tap NFC tag with payment
   - Should navigate to payment screen

3. **NFC read while app closed:**
   - Close app completely
   - Tap NFC tag with payment
   - App should open to payment screen

## Files to Modify
- `mobile/app.json` (deep link config)
- `mobile/app/_layout.tsx` (deep link handling)
- `mobile/lib/nfc/nfc-manager.ts` (background handling)
- `mobile/providers/nfc-provider.tsx` (permissions)
- `mobile/components/nfc/nfc-status.tsx` (UI states)
- `mobile/app/(tabs)/settings.tsx` (NFC toggle)

## DO NOT
- Continuously scan for NFC (battery drain)
- Ignore NFC errors (show user-friendly messages)
- Skip permission checks
- Hardcode payment IDs for testing
