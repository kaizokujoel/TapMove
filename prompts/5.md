# Prompt 5: Merchant Terminal Real-time Payment Status

## Objective
Implement real-time payment status updates using polling (or WebSocket) so merchants see instant confirmation when customers pay.

## Pre-requisites
1. **Read issues first**: Check `docs/issues/ui/README.md`
2. **Prompt 1 and 2 must be completed** - Backend must have persistence
3. **Load skill**: `skill: "ui-dev"`

## Context
Currently the merchant terminal polls for payment status, but needs:
- More responsive updates (faster polling during active payment)
- Clear visual feedback when payment completes
- Sound/vibration notification on success
- Auto-clear after successful payment

## Tasks

### 1. Improve payment status polling
Update `merchant/src/hooks/use-payment-status.ts`:

```typescript
// Adaptive polling - faster when payment is active
const POLLING_INTERVALS = {
  IDLE: 10000,      // 10 seconds when no active payment
  ACTIVE: 1000,     // 1 second during active payment
  COMPLETING: 500,  // 500ms right after customer taps
};
```

### 2. Add WebSocket support (optional enhancement)
If time permits, add Socket.io for real-time:

Backend (`backend/src/index.js`):
```javascript
import { Server } from 'socket.io';

const io = new Server(server, { cors: { origin: '*' } });

io.on('connection', (socket) => {
  socket.on('subscribe:payment', (paymentId) => {
    socket.join(`payment:${paymentId}`);
  });
});

// Emit on payment complete
export const emitPaymentComplete = (paymentId, data) => {
  io.to(`payment:${paymentId}`).emit('payment:complete', data);
};
```

### 3. Add success notification
Update `merchant/src/components/payment/success-modal.tsx`:
- Play success sound on payment complete
- Add confetti animation (optional)
- Show transaction hash with explorer link
- Auto-close after 5 seconds

```typescript
// Add to success modal
useEffect(() => {
  if (isOpen) {
    // Play success sound
    const audio = new Audio('/sounds/success.mp3');
    audio.play().catch(() => {}); // Ignore if blocked

    // Auto-close after 5 seconds
    const timer = setTimeout(() => onClose(), 5000);
    return () => clearTimeout(timer);
  }
}, [isOpen]);
```

### 4. Add payment progress indicator
Create `merchant/src/components/payment/payment-progress.tsx`:

```typescript
type PaymentPhase = 'waiting' | 'processing' | 'confirming' | 'complete';

// Show visual progress:
// [●○○○] Waiting for customer
// [●●○○] Processing payment
// [●●●○] Confirming on-chain
// [●●●●] Complete!
```

### 5. Update active payment component
In `merchant/src/components/payment/active-payment.tsx`:
- Show countdown timer for expiry
- Pulse animation while waiting
- Clear transition to success state
- Add "Cancel Payment" confirmation dialog

### 6. Add receipt generation
After successful payment, offer receipt:
```typescript
const generateReceipt = (payment: Payment) => ({
  merchantName: merchant.name,
  amount: payment.amount,
  currency: 'USDC',
  timestamp: new Date().toISOString(),
  txHash: payment.txHash,
  paymentId: payment.id,
});

// Option to print or email receipt
```

### 7. Add payment history auto-refresh
When a payment completes, refresh the transaction table to show it immediately.

### 8. Add error recovery UI
If payment fails, show:
- Clear error message
- Retry option (create new payment with same amount)
- Contact support link

## Verification
1. Create payment on merchant terminal
2. Scan QR with mobile app
3. Complete payment
4. Verify merchant terminal shows success within 2 seconds
5. Verify transaction appears in history

## Files to Create/Modify
- `merchant/src/hooks/use-payment-status.ts` (adaptive polling)
- `merchant/src/components/payment/success-modal.tsx` (notifications)
- `merchant/src/components/payment/payment-progress.tsx` (NEW)
- `merchant/src/components/payment/active-payment.tsx` (improvements)
- `merchant/public/sounds/success.mp3` (NEW - add success sound)
- `backend/src/index.js` (WebSocket - optional)

## DO NOT
- Poll more than once per second
- Auto-create new payment after success (let merchant decide)
- Block UI during polling
- Skip error handling for WebSocket disconnects
