# Prompt 6: NFC Tag Writing for Merchant Terminal

## Objective
Implement NFC tag writing on the merchant terminal so merchants can write payment requests to NFC tags/cards for customers to tap.

## Pre-requisites
1. **Read issues first**: Check `docs/issues/ui/README.md` and `docs/issues/movement/README.md`
2. **Load skill**: `skill: "nfc-payments"`
3. **Chrome on Android required** - Web NFC only works in Chrome 89+ on Android

## Context
The merchant terminal has NFC broadcast UI but needs full implementation of Web NFC API for writing payment data to NFC tags.

## Tasks

### 1. Create NFC service for web
Create `merchant/src/lib/nfc-service.ts`:

```typescript
// Check if Web NFC is supported
export const isNfcSupported = (): boolean => {
  return 'NDEFReader' in window;
};

// Request NFC permission
export const requestNfcPermission = async (): Promise<boolean> => {
  try {
    const ndef = new NDEFReader();
    await ndef.scan(); // This triggers permission prompt
    return true;
  } catch (error) {
    console.error('NFC permission denied:', error);
    return false;
  }
};

// Write payment URI to NFC tag
export const writePaymentToNfc = async (paymentId: string): Promise<void> => {
  const ndef = new NDEFReader();
  const uri = `tapmove://pay?id=${paymentId}`;

  await ndef.write({
    records: [
      { recordType: 'url', data: uri }
    ]
  });
};
```

### 2. Add TypeScript types for Web NFC
Create `merchant/src/types/web-nfc.d.ts`:

```typescript
interface NDEFReader {
  new(): NDEFReader;
  scan(options?: NDEFScanOptions): Promise<void>;
  write(message: NDEFMessageInit, options?: NDEFWriteOptions): Promise<void>;
  onreading: ((event: NDEFReadingEvent) => void) | null;
  onreadingerror: ((event: Event) => void) | null;
}

interface NDEFMessageInit {
  records: NDEFRecordInit[];
}

interface NDEFRecordInit {
  recordType: string;
  data?: string | BufferSource;
  mediaType?: string;
  id?: string;
  encoding?: string;
  lang?: string;
}

declare global {
  interface Window {
    NDEFReader: typeof NDEFReader;
  }
}
```

### 3. Update NFC broadcast component
Update `merchant/src/components/payment/nfc-broadcast.tsx`:

```typescript
const NfcBroadcast = ({ paymentId, isActive }: Props) => {
  const [nfcStatus, setNfcStatus] = useState<'checking' | 'unsupported' | 'ready' | 'writing' | 'success' | 'error'>('checking');
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (isNfcSupported()) {
      setNfcStatus('ready');
    } else {
      setNfcStatus('unsupported');
    }
  }, []);

  const handleWriteNfc = async () => {
    setNfcStatus('writing');
    try {
      await writePaymentToNfc(paymentId);
      setNfcStatus('success');
    } catch (err) {
      setError(err.message);
      setNfcStatus('error');
    }
  };

  // Render based on status...
};
```

### 4. Add NFC status indicator
Show clear status in UI:
- üì± **Ready** - "Tap NFC tag to write payment"
- ‚è≥ **Writing** - "Hold tag steady..."
- ‚úÖ **Success** - "Payment written! Customer can tap to pay"
- ‚ùå **Error** - "Failed to write. Try again."
- ‚ö†Ô∏è **Unsupported** - "NFC not available. Use QR code instead."

### 5. Add fallback for unsupported browsers
When NFC is not available:
- Hide NFC option
- Emphasize QR code
- Show message: "For NFC payments, use Chrome on Android"

### 6. Add NFC permission request flow
Create `merchant/src/components/payment/nfc-permission.tsx`:
- Explain why NFC permission is needed
- Button to request permission
- Handle denial gracefully

### 7. Test NFC writing flow
Test steps:
1. Open merchant terminal in Chrome on Android
2. Create a payment
3. Click "Write to NFC"
4. Hold NFC tag/card to phone
5. Verify tag is written
6. Use mobile app to read the tag

## Verification
```bash
# Run merchant terminal
cd merchant && npm run dev

# Open in Chrome on Android phone
# Navigate to payment page
# Create payment
# Test NFC write with physical NFC tag
```

## Files to Create/Modify
- `merchant/src/lib/nfc-service.ts` (NEW)
- `merchant/src/types/web-nfc.d.ts` (NEW)
- `merchant/src/components/payment/nfc-broadcast.tsx` (MODIFY)
- `merchant/src/components/payment/nfc-permission.tsx` (NEW)

## Web NFC Limitations
- **Chrome 89+ on Android only**
- **HTTPS required** (localhost works for dev)
- **User gesture required** to initiate write
- **Not available on iOS** (Safari doesn't support Web NFC)

## DO NOT
- Assume NFC is available (always check)
- Block QR code when NFC fails
- Continuously scan (only write when user clicks)
- Store sensitive data in NFC tag (only payment ID)
