# Prompt 2: Payment Expiry & Cleanup System

## Objective
Implement automatic payment expiry handling so expired payments are marked as such and merchants are notified.

## Pre-requisites
1. **Read issues first**: Check `docs/issues/movement/README.md` for any timing/expiry learnings
2. **Prompt 1 must be completed** - Database persistence required
3. **Load skill**: `skill: "code-structure"`

## Context
Payments have an `expires_at` timestamp but nothing happens when they expire. This causes:
- Stale payments showing as "pending" forever
- Merchants not knowing payment windows closed
- Potential duplicate payment attempts

## Tasks

### 1. Create expiry service
Create `backend/src/services/expiry.js`:

```javascript
// Expiry service responsibilities:
// 1. Check for expired payments every 30 seconds
// 2. Mark expired payments as 'expired' status
// 3. Notify merchant webhooks of expiry
// 4. Clean up very old payments (>7 days) from active queries

const EXPIRY_CHECK_INTERVAL = 30000; // 30 seconds
const CLEANUP_AGE_DAYS = 7;
```

Key functions:
- `startExpiryChecker()` - Start the interval
- `stopExpiryChecker()` - Stop on shutdown
- `checkExpiredPayments()` - Find and expire payments
- `cleanupOldPayments()` - Archive old data

### 2. Update payment status enum
In `backend/src/lib/utils.js`, add payment statuses:
```javascript
const PAYMENT_STATUS = {
  PENDING: 'pending',
  PROCESSING: 'processing',
  COMPLETED: 'completed',
  EXPIRED: 'expired',
  FAILED: 'failed',
  REFUNDED: 'refunded'
};
```

### 3. Update db.js with expiry queries
Add to `backend/src/lib/db.js`:
```javascript
// Find all expired pending payments
getExpiredPayments()

// Batch update payment statuses
batchUpdateStatus(ids, status)

// Get payments older than X days
getOldPayments(daysOld)
```

### 4. Integrate expiry checker in server startup
In `backend/src/index.js`:
```javascript
import { startExpiryChecker, stopExpiryChecker } from './services/expiry.js';

// Start on server init
startExpiryChecker();

// Graceful shutdown
process.on('SIGTERM', () => {
  stopExpiryChecker();
  // ... other cleanup
});
```

### 5. Send webhook on expiry
Update webhook service to handle expiry events:
```javascript
// In expiry.js, after marking payment expired:
await notifyMerchant(payment.merchant_address, {
  type: 'payment.expired',
  payment_id: payment.id,
  amount: payment.amount,
  expired_at: Date.now()
});
```

### 6. Update payment status endpoint
Ensure `GET /api/payments/:id/status` returns correct status for expired payments.

## Verification
```bash
# Create a payment with short expiry (modify for testing)
curl -X POST http://localhost:3001/api/payments \
  -H "Content-Type: application/json" \
  -d '{"merchantAddress":"0x123","amount":"5.00","expirySeconds":60}'

# Wait 60+ seconds, then check status
curl http://localhost:3001/api/payments/{id}/status
# Should return: {"status": "expired"}

# Check logs for expiry checker running
```

## Files to Create/Modify
- `backend/src/services/expiry.js` (NEW)
- `backend/src/lib/utils.js` (MODIFY - add statuses)
- `backend/src/lib/db.js` (MODIFY - add queries)
- `backend/src/index.js` (MODIFY - start checker)
- `backend/src/services/webhook.js` (MODIFY - expiry events)

## DO NOT
- Use external job queues (BullMQ) - simple setInterval is fine for MVP
- Delete expired payments - just mark status
- Check more frequently than 30 seconds
