# Prompt 9: End-to-End Integration Testing

## Objective
Create comprehensive tests to verify the complete payment flow works from merchant creation to payment confirmation.

## Pre-requisites
1. **Read issues first**: Check all `docs/issues/*/README.md` folders
2. **Prompts 1-8 should be completed**
3. **All services running**: backend, mobile (Expo), merchant terminal

## Context
We need to verify the entire system works together before demo. This includes:
- Merchant registration flow
- Payment creation and QR generation
- Mobile app payment processing
- On-chain transaction
- Status updates and notifications

## Tasks

### 1. Create test script for backend
Create `backend/tests/e2e.test.js`:

```javascript
import { describe, it, expect, beforeAll } from 'vitest';

describe('E2E Payment Flow', () => {
  let merchantAddress;
  let paymentId;

  beforeAll(async () => {
    // Setup: Create test merchant
  });

  it('should register a merchant', async () => {
    const res = await fetch('http://localhost:3001/api/merchant/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: 'Test Coffee Shop',
        category: 'Food & Beverage',
      }),
    });

    expect(res.status).toBe(200);
    const data = await res.json();
    expect(data.address).toBeDefined();
    merchantAddress = data.address;
  });

  it('should create a payment', async () => {
    const res = await fetch('http://localhost:3001/api/payments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        merchantAddress,
        amount: '10.00',
        memo: 'Test Order #1',
      }),
    });

    expect(res.status).toBe(200);
    const data = await res.json();
    expect(data.id).toBeDefined();
    expect(data.qrData).toBeDefined();
    paymentId = data.id;
  });

  it('should get payment details', async () => {
    const res = await fetch(`http://localhost:3001/api/payments/${paymentId}`);

    expect(res.status).toBe(200);
    const data = await res.json();
    expect(data.amount).toBe('10.00');
    expect(data.status).toBe('pending');
  });

  it('should build payment transaction', async () => {
    const res = await fetch(`http://localhost:3001/api/payments/${paymentId}/build`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        payerAddress: '0x1234...', // Test payer
      }),
    });

    expect(res.status).toBe(200);
    const data = await res.json();
    expect(data.transaction).toBeDefined();
  });

  // More tests...
});
```

### 2. Create manual test checklist
Create `docs/testing/manual-test-checklist.md`:

```markdown
# TapMove Manual Test Checklist

## Prerequisites
- [ ] Backend running on localhost:3001
- [ ] Merchant terminal running on localhost:3000
- [ ] Mobile app running on physical Android device
- [ ] Contracts deployed to Movement testnet
- [ ] Test USDC in mobile wallet

## Merchant Registration
- [ ] Can access registration page
- [ ] Form validation works
- [ ] Registration creates on-chain merchant
- [ ] Redirects to dashboard after registration

## Payment Creation
- [ ] Can enter payment amount
- [ ] Can add memo/description
- [ ] QR code generates correctly
- [ ] Payment expires after timeout

## QR Code Payment
- [ ] Mobile app can scan QR code
- [ ] Payment details display correctly
- [ ] Balance check works
- [ ] Signing prompts for biometrics
- [ ] Transaction submits successfully
- [ ] Success screen shows
- [ ] Merchant terminal shows success

## NFC Payment (Android only)
- [ ] NFC tag can be written from merchant terminal
- [ ] Mobile app reads NFC tag
- [ ] Same flow as QR after reading

## Transaction History
- [ ] Payment appears in mobile history
- [ ] Payment appears in merchant dashboard
- [ ] Transaction details are correct
- [ ] Receipt can be viewed

## Error Handling
- [ ] Insufficient balance shows error
- [ ] Expired payment shows error
- [ ] Network error shows retry option
- [ ] Invalid QR shows error
```

### 3. Create demo script
Create `docs/demo/demo-script.md`:

```markdown
# TapMove Demo Script

## Setup (Before Demo)
1. Start all services
2. Have test USDC in mobile wallet
3. Open merchant terminal in browser
4. Open mobile app on Android phone

## Demo Flow (3 minutes)

### 1. Show the Problem (30s)
"Crypto payments are too complex. Watch how many steps..."
[Show typical wallet → scan → confirm flow]

### 2. Show TapMove Solution (2m)

**Merchant Side:**
"Merchant enters $25 for a coffee order..."
[Create payment, show QR code]

**Customer Side:**
"Customer just taps their phone..."
[Scan QR / tap NFC]
[Show payment confirmation]
[Confirm with Face ID]

**Instant Settlement:**
"And it's done. Sub-second finality on Movement."
[Show success on both screens]

### 3. Key Points (30s)
- No seed phrases (Privy embedded wallet)
- Sub-second settlement (Movement FFS)
- 0.5% fees vs 3% credit cards
```

### 4. Create test data seeding script
Create `backend/scripts/seed-test-data.js`:

```javascript
// Seed test merchants and payments for demo
const testMerchants = [
  { name: 'Coffee Shop', category: 'Food & Beverage' },
  { name: 'Bookstore', category: 'Retail' },
  { name: 'Gas Station', category: 'Services' },
];

const seedDatabase = async () => {
  for (const merchant of testMerchants) {
    await registerMerchant(merchant);
  }
  console.log('Test data seeded!');
};
```

### 5. Add health check endpoint
In `backend/src/routes/health.js`:
```javascript
router.get('/health', async (req, res) => {
  const checks = {
    database: await checkDatabase(),
    movement: await checkMovementConnection(),
    timestamp: Date.now(),
  };

  const healthy = Object.values(checks).every(c => c !== false);
  res.status(healthy ? 200 : 503).json(checks);
});
```

### 6. Create integration test runner
Add to `package.json` in root:
```json
{
  "scripts": {
    "test:e2e": "cd backend && npm test",
    "test:all": "npm run test:e2e",
    "seed": "cd backend && node scripts/seed-test-data.js"
  }
}
```

## Verification
Run full test suite:
```bash
# Start all services
npm run dev --prefix backend &
npm run dev --prefix merchant &
npm run start --prefix mobile &

# Run E2E tests
npm run test:e2e

# Check health
curl http://localhost:3001/api/health
```

## Files to Create
- `backend/tests/e2e.test.js` (NEW)
- `docs/testing/manual-test-checklist.md` (NEW)
- `docs/demo/demo-script.md` (NEW)
- `backend/scripts/seed-test-data.js` (NEW)
- `backend/src/routes/health.js` (NEW)
- `package.json` in root (NEW - workspace scripts)

## DO NOT
- Skip manual testing (automated tests aren't enough)
- Test only happy paths
- Ignore mobile app testing
- Demo without practice run
